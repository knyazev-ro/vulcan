# Query Builder

**Query Builder** в Vulcan — это низкоуровневый инструмент для построения SQL-запросов, работающий с контекстными DTO-структурами.

## Выборка данных (Load)

### Простой запрос

```go
ctx := context.Background()

// CLoad использует конкурентную загрузку через горутины
users, err := vulcan.NewQuery[UserTest]().CLoad(ctx)

```

### Фильтрация (Where / OrWhere)

```go
// AND условия
users, err := vulcan.NewQuery[UserTest]().
    Where("id", ">", 1).
    Where("id", "!=", 3).
    CLoad(ctx)

// OR условия
sql := vulcan.NewQuery[UserTest]().
    Where("role", "=", "admin").
    OrWhere("role", "=", "moderator").
    Build().SQL()

```

### Вложенные условия (Groups)

```go
q := vulcan.NewQuery[UserTest]().
    Where("active", "=", 1).
    WhereClause(func(q *vulcan.Query[UserTest]) {
        q.Where("role", "=", "admin").
            OrWhereClause(func(q *vulcan.Query[UserTest]) {
                q.Where("role", "=", "moderator").
                Where("age", ">", 30)
            })
    })

```

## Связи и Джоины

### SQL Joins

```go
q := vulcan.NewQuery[UserTest]().
    InnerJoin("posts", func(jc *vulcan.Join) {
        jc.On("posts.user_id", "=", "users.id")
    }).
    LeftJoin("categories", func(jc *vulcan.Join) {
        jc.On("categories.id", "=", "posts.category_id")
    })

```

### Сортировка и Лимиты

```go
q := vulcan.NewQuery[UserTest]().
    OrderBy("desc", "id").
    Limit(50).
    Offset(10)

```

---

# ORM и Отношения

ORM Vulcan автоматически загружает граф данных, основываясь на тегах структуры.

## Описание отношений

```go
type UserTest struct {
    _       string       `type:"metadata" table:"users" pk:"id"`
    Id      int64        `type:"column" col:"id"`
    Name    string       `type:"column" col:"name"`
    // Relations
    Posts   []PostTest   `type:"relation" table:"posts" reltype:"has-many" fk:"user_id"`
    Profile ProfileTest  `type:"relation" table:"profiles" reltype:"has-one" fk:"user_id"`
}

```

## Eager Loading и фильтрация

```go
// Загрузка пользователя и только опубликованных постов
user, ok, err := vulcan.NewQuery[UserTest]().
    With("Posts", func(q *vulcan.Query[UserTest]) {
        q.Where("published", "=", 1)
    }).
    FindById(ctx, 3)

```

## Pivot-таблицы (Many-to-Many)

```go
type PostTag struct {
    _      string  `type:"metadata" table:"post_tags" pk:"post_id,tag_id" tabletype:"pivot"`
    PostId int64   `type:"column" col:"post_id"`
    TagId  int64   `type:"column" col:"tag_id"`
    Tag    TagTest `type:"relation" table:"tags" reltype:"belongs-to" fk:"tag_id"`
}

```

---

# Мутации и Транзакции

## CRUD операции

```go
// Create
vulcan.NewQuery[UserTest]().Create(ctx, map[string]any{"name": "John"})

// Update с фильтрацией
vulcan.NewQuery[UserTest]().Where("id", "=", 1).Update(ctx, map[string]any{"name": "Jack"})

// Delete
vulcan.NewQuery[UserTest]().Where("id", "=", 1).Delete(ctx)

```

## Транзакции

```go
vulcan.Transaction(ctx, func(tx *sql.Tx) error {
    query, err := vulcan.NewQuery[UserTest]().UseConn(tx)
    if err != nil {
        return err
    }
    _, err = query.Load(ctx)
    return err
})

```