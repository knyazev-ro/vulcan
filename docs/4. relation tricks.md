# Relation Tricks

–≠—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª –æ–ø–∏—Å—ã–≤–∞–µ—Ç **–ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏—ë–º—ã** –∏ **–Ω–µ–æ—á–µ–≤–∏–¥–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏** —Ä–∞–±–æ—Ç—ã —Å –æ—Ç–Ω–æ—à–µ–Ω–∏—è–º–∏ –≤ Vulcan.

–í—Å–µ –ø—Ä–∏–º–µ—Ä—ã –æ—Å–Ω–æ–≤–∞–Ω—ã –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö, –∞ –Ω–µ —Å–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏—Ö –∫–µ–π—Å–∞—Ö.

---

## 1. –ß–∞—Å—Ç–∏—á–Ω—ã–µ DTO –¥–ª—è –æ—Ç–Ω–æ—à–µ–Ω–∏–π

–û—Ç–Ω–æ—à–µ–Ω–∏—è **–Ω–µ –æ–±—è–∑–∞–Ω—ã** –±—ã—Ç—å –ø–æ–ª–Ω—ã–º–∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è–º–∏ —Ç–∞–±–ª–∏—Ü—ã.

```go
type CityShort struct {
	_    string `type:"metadata" table:"report_cities" pk:"id"`
	Id   int64  `type:"column" col:"id"`
	City string `type:"column" col:"city"`
}

type Report struct {
	_    string    `type:"metadata" table:"reports" pk:"id"`
	Id   int64     `type:"column" col:"id"`
	City CityShort `type:"relation" table:"report_cities" reltype:"belongs-to" fk:"city_id"`
}
```

üìå **–†–µ–∑—É–ª—å—Ç–∞—Ç:**
–ë–∞–∑–∞ –æ—Ç–¥–∞—ë—Ç **—Ç–æ–ª—å–∫–æ `id` –∏ `city`**, –±–µ–∑ over-fetching.

---

## 2. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –æ—Ç–Ω–æ—à–µ–Ω–∏–π –±–µ–∑ –≤–ª–∏—è–Ω–∏—è –Ω–∞ —Ä–æ–¥–∏—Ç–µ–ª—è (`With`)

`With` –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è **—Ç–æ–ª—å–∫–æ –∫ –æ—Ç–Ω–æ—à–µ–Ω–∏—é**.

```go
report, _, _ := vulcan.NewQuery[ReportData]().
	With("City", func(q *vulcan.Query[ReportData]) {
		q.Where("city", "like", "–ú–æ—Å–∫–≤–∞")
	}).
	FindById(ctx, 2)
```

* –û—Å–Ω–æ–≤–Ω–∞—è –∑–∞–ø–∏—Å—å –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞
* –û—Ç–Ω–æ—à–µ–Ω–∏–µ ‚Äî –ª–∏–±–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ, –ª–∏–±–æ –ø—É—Å—Ç–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
* –†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π WHERE –Ω–µ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç—Å—è

---

## 3. –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä –ø–æ–¥ —Ä–∞–∑–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã

–û–¥–Ω–∞ –∏ —Ç–∞ –∂–µ —Ç–∞–±–ª–∏—Ü–∞ –º–æ–∂–µ—Ç –∏–º–µ—Ç—å **–Ω–µ—Å–∫–æ–ª—å–∫–æ DTO** –ø–æ–¥ —Ä–∞–∑–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏.

```go
type UserIndex struct {
	_    string `type:"metadata" table:"users" pk:"id"`
	Id   int64  `type:"column" col:"id"`
	Name string `type:"column" col:"name"`
}

type UserFull struct {
	_     string `type:"metadata" table:"users" pk:"id"`
	Id    int64  `type:"column" col:"id"`
	Name  string `type:"column" col:"name"`
	Posts []Post `type:"relation" table:"posts" reltype:"has-many" fk:"user_id"`
}
```

**–û–¥–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞**, —Ä–∞–∑–Ω—ã–µ –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã –¥–∞–Ω–Ω—ã—Ö.

---

## 4. –ì–ª—É–±–æ–∫–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏–π

–ú–æ–∂–Ω–æ —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å **–≤–ª–æ–∂–µ–Ω–Ω—ã–µ —É—Ä–æ–≤–Ω–∏** —á–µ—Ä–µ–∑ `With`.

```go
users, _ := vulcan.NewQuery[User]().
	With("Posts", func(q *vulcan.Query[User]) {
		q.Where("published", "=", 1).
        With("Comments", func(q *vulcan.Query[User]) {
		    q.Where("approved", "=", 1)
	    })
	}).
	CLoad(ctx)
```

–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω–µ –ª–æ–º–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞.

---

## 5. –û—Ç–Ω–æ—à–µ–Ω–∏—è –∫–∞–∫ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏

–û—Ç–Ω–æ—à–µ–Ω–∏–µ –º–æ–∂–µ—Ç –±—ã—Ç—å **–∞–≥—Ä–µ–≥–∞—Ç–Ω–æ–π –ø—Ä–æ–µ–∫—Ü–∏–µ–π**, –∞ –Ω–µ —Ç–∞–±–ª–∏—Ü–µ–π.

```go
type PostCount struct {
	_     string `type:"metadata" table:"posts"`
	Count int64  `type:"column" col:"*" agg:"count"`
}

type User struct {
	_          string    `type:"metadata" table:"users" pk:"id"`
	Id         int64     `type:"column" col:"id"`
	PostsCount PostCount `type:"relation" table:"posts" reltype:"has-one" fk:"user_id"`
}
```

–ü–æ–ª—É—á–µ–Ω–∏–µ `COUNT(*)` –±–µ–∑ —Ä—É—á–Ω–æ–≥–æ SQL.

---

## 6. –û—Ç–Ω–æ—à–µ–Ω–∏—è ‚â† JOIN

Vulcan **–Ω–µ —Å—Ç—Ä–æ–∏—Ç –º–æ–Ω—Å—Ç—Ä—É–æ–∑–Ω—ã–µ JOIN-–∑–∞–ø—Ä–æ—Å—ã** –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.

–ü–æ—á–µ–º—É:

* JOIN –≤–∑—Ä—ã–≤–∞–µ—Ç –∫–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å
* –£–±–∏–≤–∞–µ—Ç –∏–Ω–¥–µ–∫—Å—ã
* –£—Å–ª–æ–∂–Ω—è–µ—Ç –≥–∏–¥—Ä–∞—Ç–∞—Ü–∏—é

–í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ:

* –æ—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ø—Ä–æ—Å
* –∑–∞—Ç–µ–º relation queries
* —Å–≤—è–∑—ã–≤–∞–Ω–∏–µ –≤ –ø–∞–º—è—Ç–∏

–ü—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å O(n).

---

## 7. –û—Ç–Ω–æ—à–µ–Ω–∏—è ‚Äî —á–∞—Å—Ç—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞, –∞ –Ω–µ –∑–∞–ø—Ä–æ—Å–∞

–ï—Å–ª–∏ –ø–æ–ª–µ –µ—Å—Ç—å –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ ‚Äî –æ–Ω–æ **–±—É–¥–µ—Ç –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ**.
–î–∞–∂–µ –µ—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –ø—É—Å—Ç–æ–π.

```go
type User struct {
	Id    int64
	Posts []Post
}
```

## 8. –û—Ç–Ω–æ—à–µ–Ω–∏—è –º–æ–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å –±–µ–∑ –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–Ω–∏—è –ª–æ–≥–∏–∫–∏

–ü—Ä–æ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥—Ä—É–≥—É—é DTO.

```go
type UserNoRelations struct {
	_    string `type:"metadata" table:"users" pk:"id"`
	Id   int64  `type:"column" col:"id"`
	Name string `type:"column" col:"name"`
}
```